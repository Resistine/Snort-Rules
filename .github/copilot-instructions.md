# Copilot instructions for this repository

Be concise and prefer minimal, correct changes. This repository contains scripts to parse Snort community rules
and map them to MITRE ATT&CK data. The goal for an AI coding agent is to implement small, focused improvements
or fixes (parsing edge-cases, mapping logic, output formatting) while preserving existing CSV schema and CLI behavior.

Key places to read first
- `Snort-Rules/parse_snort_rules.py` — main runnable script: downloads MITRE data, downloads/extracts Snort rules,
  parses each rule with the local `snortparser` and writes `rules_parsed.csv`.
- `snortparser/snortparser.py` — Snort rule parsing library (forked). Use the `Parser` class for rule header/options.
- `mappings.csv` (root) — project-specific mapping of Snort `classtype` → ATT&CK Tactics/Techniques. Required at runtime.
- `enterprise-attack/` — generated by `mitreattack.attackToExcel.export()`; delete to refresh.

Quick dev/run notes
- Create/activate the project's venv and install dependencies (example):
  ```bash
  source venv/bin/activate
  pip install -r requirements.txt  # if provided
  pip install mitreattack-python pandas
  ```
- Run the parser (from repo root):
  ```bash
  python3 Snort-Rules/parse_snort_rules.py
  ```
- First run may download and extract `enterprise-attack` and `snort3-community-rules`.
  To force-refresh either delete the corresponding directory and re-run.

Project-specific patterns and conventions
- The parser writes a single CSV `rules_parsed.csv` with a fixed `COLUMNS` order. Keep changes backward-compatible
  when adding fields (append columns, do not reorder existing columns unless you update consumers).
- `pd.NA` is used to represent missing values; code expects pandas DataFrames and uses `to_csv(index=False, header=False)`
  when appending rows.
- Mapping logic central to the project is in `get_TActic()` and `mappings.csv`. Look up `classtype` keys and per-direction
  columns (`TA_inb`, `TA_lat`, `TA_out`, `TActic`). Prefer non-invasive fixes that handle NaNs and whitespace.
- Direction inference is in `get_direction(source, arrow, destination)` — it's heuristic and intentionally simple. If you
  need to improve it, add tests and document new behaviors.

Common failure modes and debugging tips
- `snortparser.Parser` raises `ValueError` for unparseable rules — `parse_snort_rules.py` logs exception, stacktrace and the rule.
  Reproduce by feeding the rule string into `snortparser.Parser(rule)` interactively.
- `mappings.csv` missing: the script exits early. If editing mappings, preserve header names used by `get_TActic()`.
- Reference fields in rules are parsed via `ast.literal_eval(reference)` and filtered for `attack.mitre.org/techniques/` URLs.
  Expect malformed reference strings — wrap parsing in try/except as needed.

Examples to reference when changing behavior
- To inspect why a mapping lookup failed, open the mapping DataFrame printed at startup in `parse_snort_rules.py`.
- To add an additional column derived from options, follow the single-row `DataFrame` creation pattern near the top of
  the rule loop (the script builds a single-row `df` and writes it with `to_csv`).

Pull request guidance for AI edits
- Keep changes small and well-scoped (ideally one function or bugfix per PR).
- Add a short unit test or a reproducible snippet when changing parsing logic; show both input rule and expected CSV row.
- If you add dependencies, update `requirements.txt` and document why they are needed in this file.

If something is unclear or you need a different focus (tests, refactor, mapping improvements), say which area to prioritize.
